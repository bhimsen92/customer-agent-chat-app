{% extends "base.html" %}
{% block css %}
    <link href="/static/css/conversation.css" rel="stylesheet" type="text/css" />
{% endblock %}

{% block content %}
<div id="chat-box">
    <div id="messages">
        <p id="loader">Loading.......</p>
    </div>
    <div id="message-input-form">
        <form>
            <input type="text" placeholder="Please type your message here." />
            &nbsp;
            <button type="submit">Send</button>
        </form>
    </div>
</div>
<script type="text/javascript">
    let data = {{data}};
    let user_id = null, conversation_id = null, customer_name = null;

    // create a socket connection.
    let socket = io();

    // handle "receive_message"
    socket.on("receive_message", function(payload) {
        let data = payload["data"];
        let message = $("<div>").html(`<b>${data["name"]}:</b> ${data["message"]}`);
        $("#messages").append(message);
    });

    $(document).ready(function() {
        user_id = data["user_id"];
        conversation_id = data["conversation_id"];

        $("#loader").text("Loading messages.....");
        // load old messages.
        let promise = fetch(`/api/conversations/${data["conversation_id"]}/messages`, {
            method: "GET",
            credentials: "include"
        });
        promise.then(function(response) {
            return response.json();
        })
        .then(function(json) {
            let messages = [];
            for(let i = 0; i < json["items"].length; i++) {
                let message = $("<div>").html(`<b>${json[i]["username"]}:</b> ${json[i]["message"]}`);
                messages.push(message)
            }
            $("#messages").html(messages);
            $("#chat-box").show();
        })
        .catch(function(error) {
            console.log(error);
        });
        $("#message-input-form form").submit(function(event) {
            event.preventDefault();
            let $message = $("#message-input-form input");
            socket.emit("send_message", {
                "event_type": "send_message",
                "data": {
                    "message": $message.val(),
                    "conversation_id": conversation_id,
                    "user_id": user_id,
                    "is_agent": true
                },
            }, function(response) {
                if(response) {
                    $message.val("");
                    $message.focus();
                }
            });
        });
    });
</script>
{% endblock %}